@page "/file-upload"
@rendermode InteractiveAuto
@inject ILogger<Fileupload> Logger
@using System.IO
@using System.Text.RegularExpressions
@inject IJSRuntime JS

<PageTitle>File Name Modification</PageTitle>

<h1>File Upload</h1>
<div class="">
    <p>Upload up to @maxAllowedFiles of up to @maxFileSize bytes:</p>
    <div class="form-group mb-3">
        <label for="fileInput" class="input-group-text">
            Choose File(s)
            <InputFile id="fileInput" OnChange="@LoadFiles" multiple style="display: none;" />
        </label>
    </div>
</div>


@if (loadedFiles.Count > 0)
{

    <div class="input-group mb-3">
    <div class="input-group-prepend">
        <label class="input-group-text" for="operations">Options</label>
    </div>
    <select class="form-control" id="operations" @bind="selectedOperation">
        @foreach (Operation op in @operationsValue)
            {
                <option value=@op>@GetReadableOperation(@op) </option>
            }
        </select>
    </div>
    @if (RequiresFrom(selectedOperation) && RequiresTo(selectedOperation))
    {
        <div class="input-group">
    <div class="input-group-prepend">

        <span class="input-group-text" id="">From and to</span>
    </div>
    <input type="text" class="form-control" @bind:"from" @bind:event="oninput">
    <input type="text" class="form-control" @bind:"to" @bind:event="oninput">
</div>
    }
    else
    {
        @if (RequiresFrom(selectedOperation))
        {
            <div class="input-group mb-3">
    <div class="input-group-prepend">
        <span class="input-group-text" id="inputGroup-sizing-default">From</span>
    </div>
    <input type="text" @bind="from" @bind:event="oninput" class="form-control" aria-label="Default"
        aria-describedby="inputGroup-sizing-default">
</div>

        }
        @if (RequiresTo(selectedOperation))
        {
            <div class="input-group mb-3">
    <div class="input-group-prepend">
        <span class="input-group-text" id="inputGroup-sizing-default">To</span>
    </div>
    <input type="text" @bind="to" @bind:event="oninput" class="form-control" aria-label="Default"
        aria-describedby="inputGroup-sizing-default">
</div>

        }

    }



    @if (isLoading)
    {
        <p>Uploading...</p>
    }
    else
    {
        <ul class="list-group list-group-flush mb-3">
    @foreach (var file in loadedFiles)
            {
                <li class="list-group-item">@(file.TempName ?? file.File.Name)</li>
            }
        </ul>
        @if (@from != null || @to != null)
        {
            <button @onclick="ChangeTempNames" class="btn btn-success">Change file names</button>
        }
        @if (hasBeenChanged)
        {
            <button @onclick="ResetNames" class="btn btn-light">Reset names</button>
            <button @onclick="DownloadAllFiles" class="btn btn-success">Download All Files</button>
        }
    }
}

<script>
    window.downloadFileFromStream = async (fileName, contentStreamReference) => {
        const arrayBuffer = await contentStreamReference.arrayBuffer();
        const blob = new Blob([arrayBuffer]);
        const url = URL.createObjectURL(blob);
        const anchorElement = document.createElement('a');
        anchorElement.href = url;
        anchorElement.download = fileName ?? '';
        anchorElement.click();
        anchorElement.remove();
        URL.revokeObjectURL(url);
    }
</script>

@code {
    enum Operation
    {
        changeFileExt,
        addPrefix,
        addSuffix,
        addNumbering,
        removeNCharFromStart,
        removeNCharFromEnd,
        removeDoubleSpace,
        removeCharsFromList,
        replaceText,
        transformWithRegex,
        covertToLowercase,
        covertToUppercase,
        appendDateModified,
        appendDateAccessed,
    }
    private List<CustomBrowserFile> loadedFiles = new();
    private long maxFileSize = 1024 * 2000;
    @* private long maxFileSize = 1024 * 15; *@
    private int maxAllowedFiles = 10;
    private bool isLoading;
    private Operation selectedOperation = Operation.changeFileExt;

    private string? from;
    private string? to;

    private bool hasBeenChanged = false;
    Operation[] operationsValue = Enum.GetValues<Operation>();

    private void LoadFiles(InputFileChangeEventArgs e)
    {
        isLoading = true;
        loadedFiles.Clear();

        foreach (var file in e.GetMultipleFiles(maxAllowedFiles))
        {
            try
            {
                loadedFiles.Add(new CustomBrowserFile(file));
            }
            catch (Exception ex)
            {
                Logger.LogError("File: {FileName} Error: {Error}",
                file.Name, ex.Message);
            }
        }

        isLoading = false;
    }
    private async Task DownloadFile(CustomBrowserFile file)
    {
        var stream = file.File.OpenReadStream(@maxFileSize);
        var fileName = file.TempName ?? file.File.Name;

        using var streamRef = new DotNetStreamReference(stream: stream);
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }

    private async Task DownloadAllFiles()
    {
        foreach (var file in loadedFiles)
        {
            await DownloadFile(file);
        }
    }


    private String ChangeFileExt(string input, string replacement)
    {
        Logger.LogInformation("change file ext", input, replacement);
        var pattern = @"(\.[^.]+)$";
        return Regex.Replace(input, pattern, $".{replacement}");
    }

    private bool RequiresFrom(Operation operation)
    {
        switch (operation)
        {
            case Operation.changeFileExt:
            case Operation.addPrefix:
                return false;
            default:
                return false;
        }
    }
    private bool RequiresTo(Operation operation)
    {
        switch (operation)
        {
            case Operation.changeFileExt:
            case Operation.addPrefix:
                return true;
            default:
                return false;
        }
    }
    private string GetReadableOperation(Operation operation)
    {
        switch (operation)
        {
            case Operation.changeFileExt:
                return "Change file extension";
            case Operation.addPrefix:
                return "Add prefix";
            default:
                return "Whatever";
        }
    }
    private Func<string, string, string> getOperationFn(Operation operation)
    {
        switch (operation)
        {
            case Operation.changeFileExt:
                return ChangeFileExt;
            case Operation.addPrefix:
                return ChangeFileExt;
            default:
                return (_, _) => "";
        }
    }

    private void ChangeTempNames()
    {
        hasBeenChanged = true;
        Logger.LogInformation("Changing names");
        Func<string, string, string> fn = getOperationFn(selectedOperation);
        Logger.LogInformation(to);
        foreach (CustomBrowserFile file in loadedFiles)
        {
            string name = file.TempName ?? file.File.Name;
            string newName = fn(name, to ?? "");
            Logger.LogInformation(newName);
            file.TempName = newName;
            Logger.LogInformation(file.TempName);
        }
        from = null;
        to = null;
    }

    private void ResetNames()
    {
        hasBeenChanged = false;
        foreach (CustomBrowserFile f in loadedFiles)
        {
            f.TempName = null;
        }
    }
}